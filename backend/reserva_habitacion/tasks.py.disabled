from celery import shared_task
from celery.utils.log import get_task_logger
from django.core.mail import send_mail
from reserva_habitacion.models import ReservaHabitacion
from django.conf import settings
from django.utils import timezone
import time

logger = get_task_logger(__name__)

@shared_task(bind=True)
def enviar_email_confirmacion(self, id_reserva, codigo_otp):
    """
    Tarea asÃ­ncrona que envÃ­a el cÃ³digo OTP por email.
    """
    logger.info(f"--- [CELERY] Iniciando envÃ­o de OTP para reserva ID: {id_reserva} ---")
    
    try:
        # 1. Obtener la reserva
        reserva = ReservaHabitacion.objects.select_related('usuario', 'habitacion').get(pk=id_reserva)
        
        # 2. Validar email
        email_cliente = reserva.usuario.email if (reserva.usuario and reserva.usuario.email) else None
        
        if not email_cliente:
            logger.warning(f"Usuario sin email en reserva {id_reserva}")
            return f"Fallo: Usuario sin email"

        # 3. Preparar mensaje
        nombre_persona = reserva.usuario.first_name if reserva.usuario.first_name else reserva.usuario.username
        
        asunto = f"CÃ³digo de ConfirmaciÃ³n - Reserva #{reserva.codigo_confirmacion}"
        
        mensaje = (
            f"Hola {nombre_persona},\n\n"
            f"Tu cÃ³digo de confirmaciÃ³n es: {codigo_otp}\n\n"
            f"Este cÃ³digo expira en 10 minutos.\n\n"
            f"Reserva: {reserva.codigo_confirmacion}\n"
            f"Total: ${reserva.total}\n\n"
            f"Hotel Indigo"
        )

        # 4. Enviar email
        send_mail(
            asunto,
            mensaje,
            settings.DEFAULT_FROM_EMAIL,
            [email_cliente],
            fail_silently=False,
        )

        logger.info(f"Email con OTP {codigo_otp} enviado a {email_cliente}")
        return f"Email enviado exitosamente"

    except ReservaHabitacion.DoesNotExist:
        logger.error(f"Reserva {id_reserva} no encontrada")
        return f"Error: Reserva no encontrada"
    
    except Exception as exc:
        logger.error(f"Error enviando email: {exc}")
        return f"Error: {str(exc)}"

@shared_task(bind=True)
def enviar_ticket_confirmacion(self, id_reserva):
    """
    Tarea asÃ­ncrona que envÃ­a el ticket completo de reservaciÃ³n confirmada.
    """
    logger.info(f"--- [CELERY] Enviando ticket de confirmaciÃ³n para reserva ID: {id_reserva} ---")
    
    try:
        # 1. Obtener la reserva
        reserva = ReservaHabitacion.objects.select_related('usuario', 'habitacion').get(pk=id_reserva)
        
        # 2. Validar email
        email_cliente = reserva.usuario.email if (reserva.usuario and reserva.usuario.email) else None
        
        if not email_cliente:
            logger.warning(f"Usuario sin email en reserva {id_reserva}")
            return f"Fallo: Usuario sin email"

        # 3. Calcular noches
        if reserva.fecha_checkin and reserva.fecha_checkout:
            diferencia = reserva.fecha_checkout - reserva.fecha_checkin
            noches = diferencia.days
        else:
            noches = 0

        # 4. Preparar informaciÃ³n de la habitaciÃ³n
        habitacion_info = "HabitaciÃ³n no especificada"
        if reserva.habitacion:
            habitacion_info = f"HabitaciÃ³n {reserva.habitacion.numero_habitacion} - {getattr(reserva.habitacion, 'categoria', 'EstÃ¡ndar')}"

        # 5. Preparar mensaje del ticket
        nombre_persona = reserva.usuario.first_name if reserva.usuario.first_name else reserva.usuario.username
        
        asunto = f"âœ… Reserva Confirmada - Hotel Indigo #{reserva.codigo_confirmacion}"
        
        mensaje = f"""
Â¡Hola {nombre_persona}!

ğŸ‰ Â¡Tu reserva ha sido confirmada exitosamente!

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
                    TICKET DE RESERVACIÃ“N
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“‹ INFORMACIÃ“N DE LA RESERVA:
   â€¢ CÃ³digo de ConfirmaciÃ³n: {reserva.codigo_confirmacion}
   â€¢ Estado: CONFIRMADA âœ…
   â€¢ Fecha de Reserva: {reserva.fecha_creacion.strftime('%d/%m/%Y %H:%M') if reserva.fecha_creacion else 'N/A'}

ğŸ¨ DETALLES DEL HOSPEDAJE:
   â€¢ {habitacion_info}
   â€¢ Check-in: {reserva.fecha_checkin.strftime('%d/%m/%Y') if reserva.fecha_checkin else 'N/A'}
   â€¢ Check-out: {reserva.fecha_checkout.strftime('%d/%m/%Y') if reserva.fecha_checkout else 'N/A'}
   â€¢ Noches: {noches}
   â€¢ HuÃ©spedes: {reserva.huespedes}

ğŸ‘¤ INFORMACIÃ“N DEL HUÃ‰SPED:
   â€¢ Nombre: {nombre_persona}
   â€¢ Email: {email_cliente}
   â€¢ Usuario: {reserva.usuario.username}

ğŸ’° RESUMEN FINANCIERO:
   â€¢ Total de la Reserva: ${reserva.total}
   â€¢ Estado de Pago: Pendiente (Pago en mostrador)

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“ INFORMACIÃ“N IMPORTANTE:
   â€¢ Presenta este cÃ³digo al llegar: {reserva.codigo_confirmacion}
   â€¢ Check-in disponible desde las 15:00 hrs
   â€¢ Check-out hasta las 12:00 hrs
   â€¢ El pago se realiza directamente en el hotel

ğŸ“ Â¿Necesitas ayuda?
   â€¢ TelÃ©fono: +58 XXX-XXXXXXX
   â€¢ Email: info@hotelindigo.com
   â€¢ Sitio web: www.hotelindigo.com

Â¡Esperamos recibirte pronto en Hotel Indigo!

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Este es un email automÃ¡tico, por favor no responder.
Hotel Indigo - {timezone.now().strftime('%Y')}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        """

        # 6. Enviar email
        send_mail(
            asunto,
            mensaje,
            settings.DEFAULT_FROM_EMAIL,
            [email_cliente],
            fail_silently=False,
        )

        logger.info(f"Ticket de confirmaciÃ³n enviado a {email_cliente}")
        return f"Ticket enviado exitosamente"

    except ReservaHabitacion.DoesNotExist:
        logger.error(f"Reserva {id_reserva} no encontrada")
        return f"Error: Reserva no encontrada"
    
    except Exception as exc:
        logger.error(f"Error enviando ticket: {exc}")
        return f"Error: {str(exc)}"